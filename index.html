<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GitHub Activity Dashboard - YuriiHoliuk</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
    background: #0d1117;
    color: #c9d1d9;
    min-height: 100vh;
    padding: 24px;
  }

  a { color: #58a6ff; text-decoration: none; }
  a:hover { text-decoration: underline; }

  .header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    padding: 24px;
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 12px;
  }

  .header h1 {
    font-size: 1.6rem;
    color: #f0f6fc;
    font-weight: 600;
  }

  .header .date-range {
    color: #8b949e;
    font-size: 0.95rem;
    margin-top: 4px;
  }

  .header-left {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #21262d;
    color: #58a6ff;
    border: 1px solid #30363d;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    text-decoration: none;
    transition: background 0.2s, border-color 0.2s;
  }

  .back-btn:hover {
    background: #30363d;
    border-color: #58a6ff;
    text-decoration: none;
  }

  .toggle-container {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #21262d;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s;
  }

  .toggle-container:hover { background: #30363d; }

  .toggle-container input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #f78166;
    cursor: pointer;
  }

  .toggle-container label {
    cursor: pointer;
    font-size: 0.9rem;
    color: #f0f6fc;
  }

  .perm-count {
    font-size: 0.8rem;
    color: #8b949e;
    background: #30363d;
    padding: 2px 8px;
    border-radius: 10px;
  }

  .cards-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .card {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 12px;
    padding: 20px;
    transition: border-color 0.3s, transform 0.2s;
  }

  .card:hover {
    border-color: #58a6ff;
    transform: translateY(-2px);
  }

  .card .card-label {
    font-size: 0.8rem;
    color: #8b949e;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }

  .card .card-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: #f0f6fc;
  }

  .card .card-value .green { color: #3fb950; }
  .card .card-value .red { color: #f85149; }
  .card .card-value .sep { color: #484f58; font-weight: 400; }

  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
  }

  .chart-card {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 12px;
    padding: 20px;
    transition: border-color 0.3s;
  }

  .chart-card:hover { border-color: #58a6ff; }

  .chart-card h3 {
    font-size: 1rem;
    color: #f0f6fc;
    margin-bottom: 16px;
    font-weight: 600;
  }

  .chart-container {
    position: relative;
    width: 100%;
    height: 300px;
  }

  .table-section {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .table-section h3 {
    font-size: 1rem;
    color: #f0f6fc;
    margin-bottom: 16px;
    font-weight: 600;
  }

  .search-box {
    width: 100%;
    max-width: 400px;
    padding: 10px 14px;
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 8px;
    color: #c9d1d9;
    font-size: 0.9rem;
    margin-bottom: 16px;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-box:focus { border-color: #58a6ff; }
  .search-box::placeholder { color: #484f58; }

  .pr-table-wrapper { overflow-x: auto; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  thead th {
    text-align: left;
    padding: 10px 12px;
    background: #21262d;
    color: #8b949e;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    border-bottom: 1px solid #30363d;
    white-space: nowrap;
    cursor: pointer;
  }

  thead th:hover { color: #c9d1d9; }

  tbody tr {
    border-bottom: 1px solid #21262d;
    transition: background 0.15s;
  }

  tbody tr:hover { background: #1c2128; }

  tbody td {
    padding: 10px 12px;
    vertical-align: middle;
  }

  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge-merged { background: #1f6feb22; color: #a371f7; }
  .badge-open { background: #23863622; color: #3fb950; }
  .badge-closed { background: #f8514922; color: #f85149; }
  .badge-draft { background: #48505822; color: #8b949e; }
  .badge-perm { background: #f7816622; color: #f78166; font-weight: 500; margin-left: 6px; }

  .additions { color: #3fb950; }
  .deletions { color: #f85149; }

  /* Loading spinner */
  .loading-overlay {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 20px;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid #21262d;
    border-top-color: #58a6ff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 16px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-text {
    color: #8b949e;
    font-size: 0.95rem;
  }

  /* Error state */
  .error-container {
    text-align: center;
    padding: 60px 20px;
    background: #161b22;
    border: 1px solid #f8514944;
    border-radius: 12px;
    margin: 24px 0;
  }

  .error-container h2 {
    color: #f85149;
    margin-bottom: 12px;
    font-size: 1.3rem;
  }

  .error-container p {
    color: #8b949e;
    max-width: 500px;
    margin: 0 auto 20px;
    line-height: 1.6;
  }

  .retry-btn {
    display: inline-block;
    background: #21262d;
    color: #58a6ff;
    border: 1px solid #30363d;
    padding: 10px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s, border-color 0.2s;
  }

  .retry-btn:hover {
    background: #30363d;
    border-color: #58a6ff;
  }

  /* Period selector / landing view */
  .landing-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .landing-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .landing-header h1 {
    font-size: 2rem;
    color: #f0f6fc;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .landing-header p {
    color: #8b949e;
    font-size: 1.05rem;
  }

  .periods-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
  }

  .period-card {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 12px;
    padding: 24px;
    cursor: pointer;
    transition: border-color 0.3s, transform 0.2s, box-shadow 0.3s;
    text-decoration: none;
    display: block;
  }

  .period-card:hover {
    border-color: #58a6ff;
    transform: translateY(-3px);
    box-shadow: 0 4px 20px rgba(88, 166, 255, 0.1);
    text-decoration: none;
  }

  .period-card.active {
    border-color: #58a6ff;
    box-shadow: 0 0 0 1px #58a6ff;
  }

  .period-card .period-dates {
    font-size: 1.15rem;
    color: #f0f6fc;
    font-weight: 600;
    margin-bottom: 12px;
  }

  .period-card .period-stats {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }

  .period-card .period-stat {
    font-size: 0.85rem;
    color: #8b949e;
  }

  .period-card .period-stat strong {
    color: #c9d1d9;
    font-weight: 600;
  }

  /* Period selector bar in dashboard view */
  .period-selector-bar {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 24px;
  }

  .period-pill {
    display: inline-block;
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 20px;
    padding: 8px 18px;
    color: #c9d1d9;
    font-size: 0.85rem;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s, color 0.2s;
    text-decoration: none;
  }

  .period-pill:hover {
    border-color: #58a6ff;
    color: #f0f6fc;
    text-decoration: none;
  }

  .period-pill.active {
    background: #58a6ff22;
    border-color: #58a6ff;
    color: #58a6ff;
    font-weight: 600;
  }

  .hidden { display: none; }

  @media (max-width: 600px) {
    body { padding: 12px; }
    .header { flex-direction: column; gap: 12px; }
    .header-right { width: 100%; justify-content: flex-start; }
    .charts-grid { grid-template-columns: 1fr; }
    .cards-row { grid-template-columns: repeat(2, 1fr); }
    .periods-grid { grid-template-columns: 1fr; }
    .landing-header h1 { font-size: 1.5rem; }
  }
</style>
</head>
<body>

<div id="app"></div>

<script>
(function() {
  'use strict';

  var COLORS = {
    blue: '#58a6ff',
    green: '#3fb950',
    red: '#f85149',
    purple: '#a371f7',
    orange: '#f78166',
    yellow: '#d29922',
    cyan: '#39d2c0',
    pink: '#f778ba',
    gray: '#8b949e'
  };

  var PALETTE = [
    '#58a6ff','#3fb950','#a371f7','#f78166','#d29922',
    '#39d2c0','#f778ba','#f85149','#8b949e','#79c0ff',
    '#7ee787','#d2a8ff','#ffa657','#e3b341','#56d4dd','#ff9bce'
  ];

  var state = {
    periods: [],
    currentPeriodKey: null,
    currentData: null,
    charts: {},
    excludePermission: false,
    sortKey: 'created_at',
    sortAsc: false
  };

  var appEl = document.getElementById('app');

  // --- Utility functions ---

  function formatPeriodRange(start, end) {
    var startDate = new Date(start + 'T00:00:00');
    var endDate = new Date(end + 'T00:00:00');
    var sameMonth = startDate.getFullYear() === endDate.getFullYear()
      && startDate.getMonth() === endDate.getMonth();

    var startStr = startDate.toLocaleDateString('en-US', {
      month: 'short', day: 'numeric'
    });

    if (sameMonth) {
      return startStr + ' - '
        + endDate.getDate() + ', '
        + endDate.getFullYear();
    }

    var endStr = endDate.toLocaleDateString('en-US', {
      month: 'short', day: 'numeric', year: 'numeric'
    });

    return startStr + ' - ' + endStr;
  }

  function periodKey(period) {
    return period.start + '_to_' + period.end;
  }

  function periodFromHash() {
    var hash = window.location.hash;
    var match = hash.match(/^#period=(.+)$/);
    return match ? match[1] : null;
  }

  function setHash(key) {
    if (key) {
      window.location.hash = 'period=' + key;
    } else {
      history.pushState(null, '', window.location.pathname);
    }
  }

  function getRepo(pr) {
    return pr.repo_url.split('/').pop();
  }

  function getCategory(pr) {
    var match = pr.title.match(/^\[([^\]]+)\]/);
    return match ? match[1] : 'Other';
  }

  function isPermission(pr) {
    return /permission/i.test(pr.title);
  }

  function getStatus(pr) {
    if (pr.merged) return 'Merged';
    if (pr.state === 'open' && pr.draft) return 'Draft';
    if (pr.state === 'open') return 'Open';
    return 'Closed';
  }

  function dateStr(iso) {
    if (!iso) return '-';
    var dt = new Date(iso);
    return dt.toLocaleDateString('en-US', {
      month: 'short', day: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
  }

  function toDay(iso) {
    return iso ? iso.slice(0, 10) : null;
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function getAllDates(data) {
    var dates = [];
    var start = new Date(data.period_start + 'T00:00:00');
    var end = new Date(data.period_end + 'T00:00:00');
    for (var d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      dates.push(d.toISOString().slice(0, 10));
    }
    return dates;
  }

  function getDateLabels(allDates) {
    return allDates.map(function(d) {
      var dt = new Date(d + 'T00:00:00');
      return dt.toLocaleDateString('en-US', {
        month: 'short', day: 'numeric'
      });
    });
  }

  function getFilteredPRs() {
    var prs = state.currentData.pull_requests;
    return state.excludePermission
      ? prs.filter(function(pr) { return !isPermission(pr); })
      : prs;
  }

  function getAllCommits() {
    var all = [];
    var commits = state.currentData.commits;
    for (var repo in commits) {
      var repoCommits = commits[repo];
      for (var idx = 0; idx < repoCommits.length; idx++) {
        all.push(Object.assign({}, repoCommits[idx], { repo: repo }));
      }
    }
    return all;
  }

  // --- Data fetching ---

  async function fetchIndex() {
    var response = await fetch('data/index.json');
    if (!response.ok) {
      throw new Error(
        'Failed to load periods index (HTTP ' + response.status + ')'
      );
    }
    return response.json();
  }

  async function fetchPeriodData(filename) {
    var response = await fetch('data/' + filename);
    if (!response.ok) {
      throw new Error(
        'Failed to load period data (HTTP ' + response.status + ')'
      );
    }
    return response.json();
  }

  // --- Rendering: Loading & Error ---

  function renderLoading(message) {
    appEl.innerHTML =
      '<div class="loading-overlay">' +
        '<div class="spinner"></div>' +
        '<div class="loading-text">' +
          (message || 'Loading...') +
        '</div>' +
      '</div>';
  }

  function renderError(title, message, retryFn) {
    appEl.innerHTML =
      '<div class="error-container">' +
        '<h2>' + escapeHtml(title) + '</h2>' +
        '<p>' + escapeHtml(message) + '</p>' +
        (retryFn
          ? '<button class="retry-btn" id="retryBtn">Try Again</button>'
          : '') +
      '</div>';
    if (retryFn) {
      document.getElementById('retryBtn')
        .addEventListener('click', retryFn);
    }
  }

  // --- Rendering: Landing / Period selection ---

  function renderLanding() {
    var periods = state.periods;

    var html =
      '<div class="landing-container">' +
        '<div class="landing-header">' +
          '<h1>GitHub Activity Dashboard</h1>' +
          '<p>YuriiHoliuk &mdash; Select a period to view</p>' +
        '</div>' +
        '<div class="periods-grid">';

    for (var idx = 0; idx < periods.length; idx++) {
      var period = periods[idx];
      var key = periodKey(period);
      var range = formatPeriodRange(period.start, period.end);
      var prCount = period.pr_count !== undefined
        ? period.pr_count : '?';
      var commitCount = period.commit_count !== undefined
        ? period.commit_count : '?';

      html +=
        '<a class="period-card" href="#period=' + key + '"' +
          ' data-period="' + key + '">' +
          '<div class="period-dates">' + range + '</div>' +
          '<div class="period-stats">' +
            '<span class="period-stat">' +
              '<strong>' + prCount + '</strong> PRs' +
            '</span>' +
            '<span class="period-stat">' +
              '<strong>' + commitCount + '</strong> Commits' +
            '</span>' +
          '</div>' +
        '</a>';
    }

    html += '</div></div>';
    appEl.innerHTML = html;

    var cards = appEl.querySelectorAll('.period-card');
    cards.forEach(function(card) {
      card.addEventListener('click', function(event) {
        event.preventDefault();
        var cardKey = card.getAttribute('data-period');
        setHash(cardKey);
        navigateToPeriod(cardKey);
      });
    });
  }

  // --- Rendering: Dashboard ---

  function renderDashboard() {
    var data = state.currentData;
    var currentPeriod = state.periods.find(function(p) {
      return periodKey(p) === state.currentPeriodKey;
    });
    var dateRange = currentPeriod
      ? formatPeriodRange(currentPeriod.start, currentPeriod.end)
      : (data.period_start + ' to ' + data.period_end);

    var showBackButton = state.periods.length > 1;
    var permCount = data.pull_requests.filter(isPermission).length;

    var periodPillsHtml = '';
    if (state.periods.length > 1) {
      periodPillsHtml = '<div class="period-selector-bar" id="periodBar">';
      for (var idx = 0; idx < state.periods.length; idx++) {
        var period = state.periods[idx];
        var key = periodKey(period);
        var range = formatPeriodRange(period.start, period.end);
        var isActive = key === state.currentPeriodKey;
        periodPillsHtml +=
          '<a class="period-pill' + (isActive ? ' active' : '') + '"' +
            ' href="#period=' + key + '"' +
            ' data-period="' + key + '">' +
            range +
          '</a>';
      }
      periodPillsHtml += '</div>';
    }

    var html =
      '<div class="header">' +
        '<div class="header-left">' +
          '<h1>GitHub Activity Dashboard - YuriiHoliuk</h1>' +
          '<div class="date-range">' + dateRange + '</div>' +
        '</div>' +
        '<div class="header-right">' +
          (showBackButton
            ? '<a class="back-btn" href="#" id="backBtn">' +
                '&larr; All Periods</a>'
            : '') +
          '<div class="toggle-container" id="toggleContainer">' +
            '<input type="checkbox" id="permToggle"' +
              (state.excludePermission ? ' checked' : '') + '>' +
            '<label for="permToggle">Exclude Permission PRs</label>' +
            '<span class="perm-count" id="permCount">' +
              permCount + ' PRs</span>' +
          '</div>' +
        '</div>' +
      '</div>' +

      periodPillsHtml +

      '<div class="cards-row" id="summaryCards"></div>' +

      '<div class="charts-grid">' +
        '<div class="chart-card"><h3>Daily Activity</h3>' +
          '<div class="chart-container">' +
            '<canvas id="chartDaily"></canvas>' +
          '</div></div>' +
        '<div class="chart-card"><h3>PR Categories</h3>' +
          '<div class="chart-container">' +
            '<canvas id="chartCategories"></canvas>' +
          '</div></div>' +
        '<div class="chart-card"><h3>Code Volume by Day</h3>' +
          '<div class="chart-container">' +
            '<canvas id="chartCodeVolume"></canvas>' +
          '</div></div>' +
        '<div class="chart-card"><h3>PR Status Distribution</h3>' +
          '<div class="chart-container">' +
            '<canvas id="chartStatus"></canvas>' +
          '</div></div>' +
        '<div class="chart-card"><h3>PR Size Distribution</h3>' +
          '<div class="chart-container">' +
            '<canvas id="chartSize"></canvas>' +
          '</div></div>' +
        '<div class="chart-card"><h3>Repository Distribution</h3>' +
          '<div class="chart-container">' +
            '<canvas id="chartRepo"></canvas>' +
          '</div></div>' +
        '<div class="chart-card"><h3>Commits Timeline</h3>' +
          '<div class="chart-container">' +
            '<canvas id="chartCommits"></canvas>' +
          '</div></div>' +
      '</div>' +

      '<div class="table-section">' +
        '<h3>Pull Requests</h3>' +
        '<input type="text" class="search-box" id="searchBox"' +
          ' placeholder="Search PRs by title, number, status,' +
          ' or category...">' +
        '<div class="pr-table-wrapper">' +
          '<table>' +
            '<thead>' +
              '<tr>' +
                '<th data-sort="number">#</th>' +
                '<th data-sort="title">Title</th>' +
                '<th data-sort="status">Status</th>' +
                '<th data-sort="created_at">Created</th>' +
                '<th data-sort="merged_at">Merged</th>' +
                '<th data-sort="changes">+/-</th>' +
                '<th data-sort="changed_files">Files</th>' +
                '<th data-sort="category">Category</th>' +
                '<th data-sort="repo">Repo</th>' +
              '</tr>' +
            '</thead>' +
            '<tbody id="prTableBody"></tbody>' +
          '</table>' +
        '</div>' +
      '</div>';

    appEl.innerHTML = html;
    bindDashboardEvents();
    rebuildDashboard();
  }

  function bindDashboardEvents() {
    var backBtn = document.getElementById('backBtn');
    if (backBtn) {
      backBtn.addEventListener('click', function(event) {
        event.preventDefault();
        setHash('');
        renderLanding();
      });
    }

    var toggleContainer = document.getElementById('toggleContainer');
    var permToggle = document.getElementById('permToggle');

    toggleContainer.addEventListener('click', function(event) {
      if (event.target !== permToggle) {
        permToggle.checked = !permToggle.checked;
      }
      state.excludePermission = permToggle.checked;
      rebuildDashboard();
    });

    permToggle.addEventListener('click', function(event) {
      event.stopPropagation();
      state.excludePermission = permToggle.checked;
      rebuildDashboard();
    });

    document.getElementById('searchBox')
      .addEventListener('input', renderTable);

    var headers = document.querySelectorAll('thead th[data-sort]');
    headers.forEach(function(th) {
      th.addEventListener('click', function() {
        var key = th.getAttribute('data-sort');
        if (state.sortKey === key) {
          state.sortAsc = !state.sortAsc;
        } else {
          state.sortKey = key;
          state.sortAsc = true;
        }
        renderTable();
      });
    });

    var pills = document.querySelectorAll('.period-pill');
    pills.forEach(function(pill) {
      pill.addEventListener('click', function(event) {
        event.preventDefault();
        var pillKey = pill.getAttribute('data-period');
        if (pillKey !== state.currentPeriodKey) {
          setHash(pillKey);
          navigateToPeriod(pillKey);
        }
      });
    });
  }

  // --- Chart builders ---

  function destroyCharts() {
    for (var key in state.charts) {
      state.charts[key].destroy();
    }
    state.charts = {};
  }

  function buildSummary() {
    var prs = getFilteredPRs();
    var commits = getAllCommits();
    var merged = prs.filter(function(p) { return p.merged; }).length;
    var open = prs.filter(function(p) {
      return p.state === 'open';
    }).length;
    var adds = prs.reduce(function(s, p) {
      return s + p.additions;
    }, 0);
    var dels = prs.reduce(function(s, p) {
      return s + p.deletions;
    }, 0);
    var files = prs.reduce(function(s, p) {
      return s + p.changed_files;
    }, 0);

    var cards = [
      { label: 'Total PRs', value: String(prs.length) },
      { label: 'Merged PRs', value: String(merged) },
      { label: 'Open PRs', value: String(open) },
      {
        label: 'Additions / Deletions',
        value: '<span class="green">+'
          + adds.toLocaleString() + '</span>'
          + ' <span class="sep">/</span> '
          + '<span class="red">-'
          + dels.toLocaleString() + '</span>'
      },
      { label: 'Files Changed', value: files.toLocaleString() },
      { label: 'Total Commits', value: String(commits.length) }
    ];

    document.getElementById('summaryCards').innerHTML =
      cards.map(function(c) {
        return '<div class="card">'
          + '<div class="card-label">' + c.label + '</div>'
          + '<div class="card-value">' + c.value + '</div>'
          + '</div>';
      }).join('');
  }

  function buildDailyActivity() {
    var prs = getFilteredPRs();
    var allDates = getAllDates(state.currentData);
    var dateLabels = getDateLabels(allDates);
    var created = {};
    var merged = {};
    allDates.forEach(function(d) { created[d] = 0; merged[d] = 0; });
    prs.forEach(function(pr) {
      var cd = toDay(pr.created_at);
      if (created[cd] !== undefined) created[cd]++;
      if (pr.merged_at) {
        var md = toDay(pr.merged_at);
        if (merged[md] !== undefined) merged[md]++;
      }
    });

    state.charts.daily = new Chart(
      document.getElementById('chartDaily'), {
        type: 'bar',
        data: {
          labels: dateLabels,
          datasets: [
            {
              label: 'Created',
              data: allDates.map(function(d) { return created[d]; }),
              backgroundColor: COLORS.blue + 'cc',
              borderRadius: 4
            },
            {
              label: 'Merged',
              data: allDates.map(function(d) { return merged[d]; }),
              backgroundColor: COLORS.purple + 'cc',
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#c9d1d9' } } },
          scales: {
            x: {
              ticks: { color: '#8b949e' },
              grid: { color: '#21262d' }
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#8b949e', stepSize: 1 },
              grid: { color: '#21262d' }
            }
          }
        }
      }
    );
  }

  function buildCategories() {
    var prs = getFilteredPRs();
    var cats = {};
    prs.forEach(function(pr) {
      var cat = getCategory(pr);
      cats[cat] = (cats[cat] || 0) + 1;
    });
    var sorted = Object.entries(cats)
      .sort(function(a, b) { return b[1] - a[1]; })
      .slice(0, 12);

    state.charts.categories = new Chart(
      document.getElementById('chartCategories'), {
        type: 'doughnut',
        data: {
          labels: sorted.map(function(s) { return s[0]; }),
          datasets: [{
            data: sorted.map(function(s) { return s[1]; }),
            backgroundColor: PALETTE.slice(0, sorted.length),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: '#c9d1d9', boxWidth: 12,
                padding: 8, font: { size: 11 }
              }
            }
          }
        }
      }
    );
  }

  function buildCodeVolume() {
    var prs = getFilteredPRs();
    var allDates = getAllDates(state.currentData);
    var dateLabels = getDateLabels(allDates);
    var adds = {};
    var dels = {};
    allDates.forEach(function(d) { adds[d] = 0; dels[d] = 0; });
    prs.forEach(function(pr) {
      if (pr.merged_at) {
        var day = toDay(pr.merged_at);
        if (adds[day] !== undefined) {
          adds[day] += pr.additions;
          dels[day] += pr.deletions;
        }
      }
    });

    state.charts.codeVolume = new Chart(
      document.getElementById('chartCodeVolume'), {
        type: 'bar',
        data: {
          labels: dateLabels,
          datasets: [
            {
              label: 'Additions',
              data: allDates.map(function(d) { return adds[d]; }),
              backgroundColor: COLORS.green + 'cc',
              borderRadius: 4
            },
            {
              label: 'Deletions',
              data: allDates.map(function(d) { return dels[d]; }),
              backgroundColor: COLORS.red + 'cc',
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#c9d1d9' } } },
          scales: {
            x: {
              stacked: true,
              ticks: { color: '#8b949e' },
              grid: { color: '#21262d' }
            },
            y: {
              stacked: true, beginAtZero: true,
              ticks: { color: '#8b949e' },
              grid: { color: '#21262d' }
            }
          }
        }
      }
    );
  }

  function buildStatus() {
    var prs = getFilteredPRs();
    var statuses = { Merged: 0, Open: 0, Closed: 0, Draft: 0 };
    prs.forEach(function(pr) { statuses[getStatus(pr)]++; });
    var active = Object.entries(statuses)
      .filter(function(entry) { return entry[1] > 0; });
    var statusColors = {
      Merged: COLORS.purple, Open: COLORS.green,
      Closed: COLORS.red, Draft: COLORS.gray
    };

    state.charts.status = new Chart(
      document.getElementById('chartStatus'), {
        type: 'doughnut',
        data: {
          labels: active.map(function(entry) { return entry[0]; }),
          datasets: [{
            data: active.map(function(entry) { return entry[1]; }),
            backgroundColor: active.map(function(entry) {
              return statusColors[entry[0]];
            }),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#c9d1d9', boxWidth: 12, padding: 8 }
            }
          }
        }
      }
    );
  }

  function buildSize() {
    var prs = getFilteredPRs();
    var sizes = {
      'XS (<10)': 0, 'S (10-50)': 0, 'M (50-200)': 0,
      'L (200-500)': 0, 'XL (500+)': 0
    };
    prs.forEach(function(pr) {
      var changes = pr.additions + pr.deletions;
      if (changes < 10) sizes['XS (<10)']++;
      else if (changes <= 50) sizes['S (10-50)']++;
      else if (changes <= 200) sizes['M (50-200)']++;
      else if (changes <= 500) sizes['L (200-500)']++;
      else sizes['XL (500+)']++;
    });

    state.charts.size = new Chart(
      document.getElementById('chartSize'), {
        type: 'bar',
        data: {
          labels: Object.keys(sizes),
          datasets: [{
            label: 'PRs',
            data: Object.values(sizes),
            backgroundColor: [
              COLORS.cyan + 'cc', COLORS.green + 'cc',
              COLORS.blue + 'cc', COLORS.orange + 'cc',
              COLORS.red + 'cc'
            ],
            borderRadius: 4
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              ticks: { color: '#8b949e' },
              grid: { color: '#21262d' }
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#8b949e', stepSize: 1 },
              grid: { color: '#21262d' }
            }
          }
        }
      }
    );
  }

  function buildRepo() {
    var prs = getFilteredPRs();
    var repos = {};
    prs.forEach(function(pr) {
      var repo = getRepo(pr);
      repos[repo] = (repos[repo] || 0) + 1;
    });
    var sorted = Object.entries(repos)
      .sort(function(a, b) { return b[1] - a[1]; });

    state.charts.repo = new Chart(
      document.getElementById('chartRepo'), {
        type: 'pie',
        data: {
          labels: sorted.map(function(s) { return s[0]; }),
          datasets: [{
            data: sorted.map(function(s) { return s[1]; }),
            backgroundColor: PALETTE.slice(0, sorted.length),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: '#c9d1d9', boxWidth: 12,
                padding: 8, font: { size: 11 }
              }
            }
          }
        }
      }
    );
  }

  function buildCommitsTimeline() {
    var commits = getAllCommits();
    var allDates = getAllDates(state.currentData);
    var dateLabels = getDateLabels(allDates);
    var perDay = {};
    allDates.forEach(function(d) { perDay[d] = 0; });
    commits.forEach(function(commit) {
      var day = toDay(commit.date);
      if (perDay[day] !== undefined) perDay[day]++;
    });

    state.charts.commits = new Chart(
      document.getElementById('chartCommits'), {
        type: 'line',
        data: {
          labels: dateLabels,
          datasets: [{
            label: 'Commits',
            data: allDates.map(function(d) { return perDay[d]; }),
            borderColor: COLORS.cyan,
            backgroundColor: COLORS.cyan + '33',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: COLORS.cyan
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#c9d1d9' } } },
          scales: {
            x: {
              ticks: { color: '#8b949e' },
              grid: { color: '#21262d' }
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#8b949e', stepSize: 1 },
              grid: { color: '#21262d' }
            }
          }
        }
      }
    );
  }

  // --- Table rendering ---

  function renderTable() {
    var prs = getFilteredPRs();
    var searchBox = document.getElementById('searchBox');
    var query = searchBox ? searchBox.value.toLowerCase() : '';

    var rows = prs.map(function(pr) {
      return {
        pr: pr,
        number: pr.number,
        title: pr.title,
        status: getStatus(pr),
        created_at: pr.created_at,
        merged_at: pr.merged_at,
        additions: pr.additions,
        deletions: pr.deletions,
        changes: pr.additions + pr.deletions,
        changed_files: pr.changed_files,
        category: getCategory(pr),
        repo: getRepo(pr),
        isPerm: isPermission(pr)
      };
    });

    if (query) {
      rows = rows.filter(function(row) {
        return row.title.toLowerCase().indexOf(query) >= 0 ||
          String(row.number).indexOf(query) >= 0 ||
          row.status.toLowerCase().indexOf(query) >= 0 ||
          row.category.toLowerCase().indexOf(query) >= 0 ||
          row.repo.toLowerCase().indexOf(query) >= 0;
      });
    }

    rows.sort(function(a, b) {
      var va = a[state.sortKey];
      var vb = b[state.sortKey];
      if (va === null || va === undefined) va = '';
      if (vb === null || vb === undefined) vb = '';
      if (typeof va === 'string') {
        va = va.toLowerCase();
        vb = String(vb).toLowerCase();
      }
      if (va < vb) return state.sortAsc ? -1 : 1;
      if (va > vb) return state.sortAsc ? 1 : -1;
      return 0;
    });

    var badgeClass = {
      Merged: 'badge-merged', Open: 'badge-open',
      Closed: 'badge-closed', Draft: 'badge-draft'
    };

    var tableBody = document.getElementById('prTableBody');
    if (tableBody) {
      tableBody.innerHTML = rows.map(function(row) {
        return '<tr>' +
          '<td>' + row.number + '</td>' +
          '<td><a href="' + row.pr.html_url + '" target="_blank">' +
            escapeHtml(row.title) + '</a>' +
            (row.isPerm
              ? '<span class="badge badge-perm">Permission</span>'
              : '') +
          '</td>' +
          '<td><span class="badge ' + badgeClass[row.status] + '">' +
            row.status + '</span></td>' +
          '<td style="white-space:nowrap">' +
            dateStr(row.created_at) + '</td>' +
          '<td style="white-space:nowrap">' +
            dateStr(row.merged_at) + '</td>' +
          '<td><span class="additions">+' + row.additions +
            '</span> <span class="deletions">-' +
            row.deletions + '</span></td>' +
          '<td>' + row.changed_files + '</td>' +
          '<td>' + escapeHtml(row.category) + '</td>' +
          '<td>' + escapeHtml(row.repo) + '</td>' +
          '</tr>';
      }).join('');
    }
  }

  // --- Rebuild all dashboard components ---

  function rebuildDashboard() {
    destroyCharts();
    buildSummary();
    buildDailyActivity();
    buildCategories();
    buildCodeVolume();
    buildStatus();
    buildSize();
    buildRepo();
    buildCommitsTimeline();
    renderTable();
  }

  // --- Navigation ---

  async function navigateToPeriod(key) {
    var period = state.periods.find(function(p) {
      return periodKey(p) === key;
    });
    if (!period) {
      renderError(
        'Period Not Found',
        'The requested period "' + key + '" was not found.',
        function() { setHash(''); init(); }
      );
      return;
    }

    renderLoading(
      'Loading dashboard for '
      + formatPeriodRange(period.start, period.end) + '...'
    );

    try {
      var data = await fetchPeriodData(period.file);
      state.currentPeriodKey = key;
      state.currentData = data;
      state.excludePermission = false;
      state.sortKey = 'created_at';
      state.sortAsc = false;
      renderDashboard();
    } catch (error) {
      renderError(
        'Failed to Load Data',
        error.message || 'An unexpected error occurred.',
        function() { navigateToPeriod(key); }
      );
    }
  }

  // --- Initialization ---

  async function init() {
    renderLoading('Loading available periods...');

    try {
      var indexData = await fetchIndex();
      state.periods = indexData.periods || [];

      if (state.periods.length === 0) {
        renderError(
          'No Data Available',
          'No periods found in the data index.',
          init
        );
        return;
      }

      var hashKey = periodFromHash();

      if (hashKey) {
        await navigateToPeriod(hashKey);
      } else if (state.periods.length === 1) {
        var singleKey = periodKey(state.periods[0]);
        setHash(singleKey);
        await navigateToPeriod(singleKey);
      } else {
        renderLanding();
      }
    } catch (error) {
      renderError(
        'Failed to Load Dashboard',
        error.message || 'Could not load the periods index.',
        init
      );
    }
  }

  // --- Hash change listener ---

  window.addEventListener('hashchange', function() {
    var hashKey = periodFromHash();
    if (hashKey) {
      if (hashKey !== state.currentPeriodKey) {
        navigateToPeriod(hashKey);
      }
    } else {
      state.currentPeriodKey = null;
      state.currentData = null;
      destroyCharts();
      if (state.periods.length > 1) {
        renderLanding();
      } else if (state.periods.length === 1) {
        var singleKey = periodKey(state.periods[0]);
        setHash(singleKey);
        navigateToPeriod(singleKey);
      }
    }
  });

  // --- Chart.js defaults ---

  Chart.defaults.color = '#c9d1d9';
  Chart.defaults.borderColor = '#21262d';

  // --- Start ---

  init();

})();
</script>
</body>
</html>
